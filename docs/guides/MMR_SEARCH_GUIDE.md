# MMR (Maximal Marginal Relevance) 검색 가이드

## 개요

MMR은 유사도 검색의 한계를 보완하기 위해 도입된 검색 기법입니다. 단순 유사도 검색은 매우 유사한 문서들이 중복으로 검색될 수 있지만, MMR은 **유사도와 다양성**을 모두 고려하여 검색 결과의 다양성을 높입니다.

## MMR 알고리즘

MMR 점수 계산 공식:
```
MMR_score = λ × relevance - (1 - λ) × max_similarity_to_selected
```

- **relevance**: 질문과 문서의 유사도
- **max_similarity_to_selected**: 이미 선택된 문서들과의 최대 유사도
- **λ (lambda)**: 다양성 파라미터
  - 0.0에 가까울수록: 유사도 우선 (기존 검색과 유사)
  - 1.0에 가까울수록: 다양성 우선 (중복 최소화)

## 사용 방법

### Week4에서 MMR 검색 사용

#### Hydra 설정 파일 (`conf/week4.yaml`)

```yaml
rag:
  use_mmr: true  # MMR 검색 활성화
  mmr_diversity: 0.5  # 다양성 파라미터 (0.0~1.0)
  top_k: 5
```

#### 명령줄에서 실행

```bash
# MMR 검색 활성화
python src/week4/run_week4.py rag.use_mmr=true rag.mmr_diversity=0.5

# 다양성 우선 (다양성 0.8)
python src/week4/run_week4.py rag.use_mmr=true rag.mmr_diversity=0.8

# 유사도 우선 (다양성 0.2)
python src/week4/run_week4.py rag.use_mmr=true rag.mmr_diversity=0.2
```

### 코드에서 직접 사용

```python
from src.week4.rag_chain import build_rag_chain
from pathlib import Path

# MMR 검색 사용
chain = build_rag_chain(
    index_dir=Path("data/processed/index/20201231-34-63/recursive"),
    use_mmr=True,
    mmr_diversity=0.5,  # 다양성 파라미터
    retrieval_k=5,
)

result = chain.invoke({"query": "질문 내용"})
print(result["result"])
```

## 다양성 파라미터 선택 가이드

| mmr_diversity 값 | 특징 | 사용 시나리오 |
|-----------------|------|-------------|
| **0.0 ~ 0.3** | 유사도 우선 | 정확한 답변이 필요한 경우, 특정 주제에 집중 |
| **0.4 ~ 0.6** | 균형잡힌 검색 | 일반적인 질의응답, 다양한 관점 필요 |
| **0.7 ~ 1.0** | 다양성 우선 | 광범위한 정보 수집, 중복 최소화 필요 |

## 예시: 유사도 검색 vs MMR 검색

### 유사도 검색 (기본)
```
질문: "코로나 대응 전략"
검색 결과:
1. 코로나 대응 전략 개요 (유사도: 0.95)
2. 코로나 대응 전략 상세 (유사도: 0.94)
3. 코로나 대응 전략 요약 (유사도: 0.93)
4. 코로나 대응 전략 분석 (유사도: 0.92)
5. 코로나 대응 전략 정리 (유사도: 0.91)
```
→ 매우 유사한 문서들이 중복으로 검색됨

### MMR 검색 (diversity=0.5)
```
질문: "코로나 대응 전략"
검색 결과:
1. 코로나 대응 전략 개요 (유사도: 0.95)
2. 코로나 대응 전략의 재무적 영향 (유사도: 0.85, 다양성: 높음)
3. 코로나 대응 전략의 고객 서비스 측면 (유사도: 0.82, 다양성: 높음)
4. 코로나 대응 전략의 운영 측면 (유사도: 0.80, 다양성: 높음)
5. 코로나 대응 전략의 마케팅 측면 (유사도: 0.78, 다양성: 높음)
```
→ 다양한 관점의 문서들이 검색됨

## 실제 실행 결과

### 테스트 환경
- **테스트 날짜**: 2024-11-14
- **인덱스**: `data/processed/index/20201231-34-63/recursive`
- **질문**: "그랜드코리아레저의 코로나 대응 전략은 무엇인가?"
- **검색 문서 수 (k)**: 5

### 성능 비교

| 항목 | 일반 유사도 검색 | MMR 검색 (diversity=0.5) |
|------|----------------|------------------------|
| **체인 구성 시간** | 7.96초 | 2.37초 |
| **응답 시간** | 11.70초 | 11.11초 |
| **답변 길이** | 1,354자 | 824자 |
| **답변 특징** | 상세하고 포괄적 | 간결하고 핵심 중심 |

### 관찰 사항

1. **응답 시간**: MMR 검색이 약간 빠름 (0.59초 차이)
   - MMR 알고리즘의 추가 계산에도 불구하고 전체 응답 시간은 유사
   - 체인 구성 시간은 MMR이 더 빠름 (캐싱 효과 가능)

2. **답변 길이**: MMR 검색이 더 간결함 (530자 차이)
   - MMR이 다양한 문서를 검색하여 중복 정보 제거
   - 핵심 정보에 집중한 답변 생성

3. **답변 품질**: 
   - 일반 유사도: 상세하고 포괄적인 답변 (사회적 가치 실현, 비대면 온라인 교육 등)
   - MMR: 간결하고 핵심 중심의 답변 (코로나19 피해 사각지대 지원, 모금 사업 등)

### 결론

MMR 검색은 **다양한 관점의 문서를 검색하여 중복을 줄이고, 더 간결하고 핵심적인 답변을 생성**합니다. 응답 시간은 거의 동일하므로, **간결한 답변이 필요한 경우 MMR 검색을 권장**합니다.

## 성능 고려사항

- **처리 시간**: MMR은 추가 계산이 필요하지만 실제 응답 시간에는 큰 차이 없음 (테스트 결과 확인)
- **메모리**: 선택된 문서들의 벡터를 저장하므로 메모리 사용량이 약간 증가
- **권장 사용**: 문서 수가 많고 다양한 관점이 필요한 경우에 특히 유용
- **답변 길이**: MMR은 더 간결한 답변을 생성하므로, 상세한 답변이 필요한 경우 일반 유사도 검색 고려

## 참고 자료

- MMR 원본 논문: Carbonell, J., & Goldstein, J. (1998). The use of MMR, diversity-based reranking for reordering documents and producing summaries.

---

**구현 위치**: `src/week4/rag_chain.py` - `DenseRetriever._mmr_search()` 메서드

